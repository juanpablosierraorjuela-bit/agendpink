<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Pink Bliss - Administraci칩n Firestore</title>
    <!-- Tailwind CSS y Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fdf2f8; }
        .app-input {
            @apply w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all font-medium text-gray-700;
        }
        .app-input-no-icon {
            @apply w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all font-medium text-gray-700;
        }
        .tab-active { @apply text-pink-600 border-pink-600 font-extrabold; }
        .tab-inactive { @apply text-gray-500 border-transparent font-bold hover:text-pink-600 hover:border-pink-300; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal Adaptable -->
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden shadow-pink-200/50">
        
        <!-- Pesta침as de Navegaci칩n -->
        <div class="flex border-b border-pink-200 overflow-x-auto">
            <button id="tab-agenda" class="tab-button py-4 px-6 text-sm border-b-2 transition duration-150 tab-active">
                <i data-lucide="calendar-heart" class="inline-block w-4 h-4 mr-1"></i> Agendar Cita
            </button>
            <button id="tab-admin-employees" class="tab-button py-4 px-6 text-sm border-b-2 transition duration-150 tab-inactive hidden">
                <i data-lucide="users-round" class="inline-block w-4 h-4 mr-1"></i> Admin. Empleados
            </button>
            <button id="tab-admin-services" class="tab-button py-4 px-6 text-sm border-b-2 transition duration-150 tab-inactive hidden">
                <i data-lucide="gem" class="inline-block w-4 h-4 mr-1"></i> Admin. Servicios
            </button>
            <button id="admin-login-btn" class="py-4 px-6 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-pink-600 transition">
                <i data-lucide="lock" class="inline-block w-4 h-4 mr-1"></i> Admin
            </button>
        </div>

        <!-- Contenido -->
        <div class="p-6 md:p-10">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-extrabold text-gray-800">Pink Bliss Agenda</h1>
            </header>

            <!-- Mensaje de Estado Global -->
            <div id="mensaje-estado" class="p-3 mb-5 rounded-xl text-center font-bold text-sm bg-gray-100 text-gray-600">
                Cargando datos. Por favor, espere...
            </div>

            <!-- SECCI칍N 1: AGENDA DE CITAS (VISIBILIDAD P칔BLICA) -->
            <div id="content-agenda">
                <!-- Formulario -->
                <form id="form-cita" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <!-- Datos Cliente -->
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-700 border-b border-pink-100 pb-2">Tus Datos</h3>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase ml-1">Tu Nombre</label>
                                <div class="relative mt-1">
                                    <i data-lucide="user" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                                    <input type="text" id="nombre" required placeholder="Ej: Ana Mar칤a" class="app-input">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase ml-1">WhatsApp / Telegram</label>
                                <div class="relative mt-1">
                                    <i data-lucide="smartphone" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                                    <input type="tel" id="contacto" required placeholder="Ej: 300 123 4567" class="app-input">
                                </div>
                            </div>
                            <p id="service-summary" class="text-sm font-semibold pt-4 text-pink-600 bg-pink-50 p-3 rounded-lg hidden"></p>
                        </div>

                        <!-- Detalles de la Cita -->
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-700 border-b border-pink-100 pb-2">Detalles</h3>
                            
                            <!-- Servicio (Din치mico de Firestore) -->
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase ml-1">Servicio</label>
                                <div class="relative mt-1">
                                    <select id="servicio" class="app-input-no-icon appearance-none cursor-pointer">
                                        <option value="">Cargando Servicios...</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Empleado (Din치mico de Firestore) -->
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase ml-1">Estilista Favorito</label>
                                <div class="relative mt-1">
                                    <select id="empleado" required class="app-input-no-icon appearance-none cursor-pointer">
                                        <option value="">Cargando Estilistas...</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Fecha y Hora -->
                        <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase ml-1">Fecha</label>
                                <input type="date" id="fecha" required class="app-input-no-icon">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase ml-1">Hora</label>
                                <input type="time" id="hora" required class="app-input-no-icon">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot칩n de Acci칩n -->
                    <button type="submit" id="btn-agendar" class="w-full bg-gradient-to-r from-pink-600 to-pink-500 text-white font-bold py-4 rounded-xl shadow-lg mt-6 flex items-center justify-center gap-2 transition hover:scale-[1.01]">
                        <span>Confirmar Reserva</span>
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div> <!-- Fin content-agenda -->


            <!-- SECCI칍N 2: ADMINISTRACI칍N DE EMPLEADOS (OCULTO) -->
            <div id="content-admin-employees" class="hidden">
                <h3 class="text-xl font-bold text-gray-700 border-b border-pink-100 pb-2 mb-4">Gesti칩n de Estilistas (Base de Datos)</h3>
                <p class="text-sm text-gray-600 mb-4">Esta informaci칩n es persistente (visible para todos). La columna "Horario" simula tu modelo `HorarioSemanal`.</p>

                <div id="employee-list" class="space-y-3 mb-6">
                    <!-- Lista de empleados se inserta aqu칤 -->
                </div>

                <button id="add-employee-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition">
                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> A침adir Nuevo Estilista
                </button>
            </div> 

            <!-- SECCI칍N 3: ADMINISTRACI칍N DE SERVICIOS (OCULTO) -->
            <div id="content-admin-services" class="hidden">
                <h3 class="text-xl font-bold text-gray-700 border-b border-pink-100 pb-2 mb-4">Gesti칩n de Servicios y Precios</h3>
                <p class="text-sm text-gray-600 mb-4">Configura la duraci칩n y el precio de cada servicio ofrecido.</p>

                <div id="service-list" class="space-y-3 mb-6">
                    <!-- Lista de servicios se inserta aqu칤 -->
                </div>

                <button id="add-service-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition">
                    <i data-lucide="scissors" class="w-5 h-5 mr-2"></i> A침adir Nuevo Servicio
                </button>
            </div>

        </div> <!-- Fin p-6 md:p-10 -->
    </div> <!-- Fin contenedor principal -->


    <!-- Modal (Ventana Emergente) para Login Admin -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-pink-600 mb-4">Acceso de Administrador</h3>
            <p class="text-sm text-gray-600 mb-4">La contrase침a por defecto es: **1234**</p>
            <input type="password" id="admin-password" required placeholder="Contrase침a Admin" class="app-input-no-icon mb-4">
            <div class="flex justify-end space-x-3">
                <button type="button" id="close-admin-modal-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition hover:bg-gray-300">Cancelar</button>
                <button type="button" id="login-admin-btn" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-lg transition hover:bg-pink-700">Entrar</button>
            </div>
        </div>
    </div>


    <!-- Modal (Ventana Emergente) para Crear/Editar Empleados -->
    <div id="employee-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl">
            <h3 class="text-xl font-bold text-pink-600 mb-4" id="employee-modal-title">A침adir Nuevo Estilista</h3>
            <form id="employee-form" class="space-y-4">
                <input type="hidden" id="employee-doc-id">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Nombre Completo</label>
                    <input type="text" id="modal-employee-name" required class="app-input-no-icon">
                </div>
                <!-- Simulaci칩n Horario Semanal -->
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Horario Semanal (Ej: L-V 9am-5pm)</label>
                    <input type="text" id="modal-employee-schedule" required class="app-input-no-icon" placeholder="Horario Laboral">
                </div>
                <!-- Selecci칩n de Servicios que Realiza (ManyToMany) -->
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Servicios que Realiza</label>
                    <div id="employee-services-checkboxes" class="grid grid-cols-2 gap-2 p-3 bg-gray-50 rounded-lg max-h-48 overflow-y-auto">
                        <p class="text-gray-500 text-sm italic">Cargando servicios...</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-employee-modal-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-lg transition hover:bg-pink-700">Guardar Estilista</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal (Ventana Emergente) para Crear/Editar Servicios -->
    <div id="service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-purple-600 mb-4" id="service-modal-title">A침adir Nuevo Servicio</h3>
            <form id="service-form" class="space-y-4">
                <input type="hidden" id="service-doc-id">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Nombre del Servicio</label>
                    <input type="text" id="modal-service-name" required class="app-input-no-icon">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Duraci칩n (minutos)</label>
                    <input type="number" id="modal-service-duration" required min="15" step="15" class="app-input-no-icon">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Precio ($)</label>
                    <input type="number" id="modal-service-price" required min="0" step="1000" class="app-input-no-icon">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-service-modal-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition hover:bg-purple-700">Guardar Servicio</button>
                </div>
            </form>
        </div>
    </div>


    <!-- L칩gica JavaScript y FIREBASE -->
    <script type="module">
        // Importaciones de Firebase (Necesarias para la BBDD)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACI칍N E INICIALIZACI칍N DE FIREBASE ---
        const apiKey = "";
        const app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let services = [];
        let employees = [];
        let isAuthenticated = false;
        
        // --- CONSTANTES ---
        const BACKEND_URL = 'https://agenda-backend-735v.onrender.com'; 
        const ADMIN_PASSWORD = '1234';
        const SERVICE_COLLECTION = `artifacts/${app_id}/public/data/services`;
        const EMPLOYEE_COLLECTION = `artifacts/${app_id}/public/data/employees`;

        // setLogLevel('debug'); // Descomentar para ver logs de Firebase

        // Funci칩n para cambiar de pesta침a
        function switchTab(activeTabId) {
            const tabs = {
                'tab-agenda': 'content-agenda',
                'tab-admin-employees': 'content-admin-employees',
                'tab-admin-services': 'content-admin-services'
            };

            Object.keys(tabs).forEach(tabId => {
                const tabButton = document.getElementById(tabId);
                const contentDiv = document.getElementById(tabs[tabId]);
                
                if (tabButton) {
                    if (tabId === activeTabId) {
                        tabButton.classList.add('tab-active');
                        tabButton.classList.remove('tab-inactive');
                        contentDiv.classList.remove('hidden');
                    } else {
                        tabButton.classList.remove('tab-active');
                        tabButton.classList.add('tab-inactive');
                        contentDiv.classList.add('hidden');
                    }
                }
            });
            showMessage('', '');
        }

        // --- UTILS Y RENDERING ---
        function showMessage(texto, tipo) {
            const div = document.getElementById('mensaje-estado');
            div.textContent = texto;
            if (tipo === 'exito') {
                div.className = "p-3 mb-5 rounded-xl text-center font-bold text-sm bg-green-100 text-green-700 border border-green-200";
            } else if (tipo === 'error') {
                div.className = "p-3 mb-5 rounded-xl text-center font-bold text-sm bg-red-100 text-red-700 border border-red-200";
            } else {
                 div.className = "p-3 mb-5 rounded-xl text-center font-bold text-sm bg-gray-100 text-gray-600";
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(amount);
        }

        // --- L칍GICA DE EMPLEADOS ---

        function renderServiceCheckboxes(employeeServiceIds = []) {
            const container = document.getElementById('employee-services-checkboxes');
            container.innerHTML = '';

            if (services.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic col-span-2">A침ade servicios primero en la pesta침a de Administraci칩n de Servicios.</p>';
                return;
            }

            services.forEach(svc => {
                const checked = employeeServiceIds.includes(svc.docId) ? 'checked' : '';
                container.innerHTML += `
                    <label class="flex items-center space-x-2 text-sm text-gray-700">
                        <input type="checkbox" name="employee-service" value="${svc.docId}" ${checked} class="rounded text-pink-600 focus:ring-pink-500">
                        <span>${svc.name} (${svc.duration_min} min)</span>
                    </label>
                `;
            });
        }

        function renderEmployeeList() {
            const listContainer = document.getElementById('employee-list');
            listContainer.innerHTML = '';
            if (employees.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 italic text-center p-4">A칰n no hay estilistas. A침ade uno para empezar.</p>';
                return;
            }

            employees.forEach(emp => {
                const employeeServices = services
                    .filter(svc => emp.service_ids && emp.service_ids.includes(svc.docId))
                    .map(svc => svc.name)
                    .join(', ');

                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-xl border border-pink-100 shadow-sm flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${emp.name}</p>
                        <p class="text-xs text-gray-500">Horario: ${emp.schedule || 'No definido'}</p>
                        <p class="text-xs text-gray-500">Servicios: ${employeeServices || 'Ninguno asignado'}</p>
                    </div>
                    <div class="space-x-2 flex items-center">
                        <button data-id="${emp.docId}" class="edit-employee-btn text-blue-500 hover:text-blue-700"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button data-id="${emp.docId}" class="delete-employee-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderEmployeeDropdown() {
            const select = document.getElementById('empleado');
            select.innerHTML = '';
            
            const selectedServiceId = document.getElementById('servicio').value;
            
            const availableEmployees = selectedServiceId 
                ? employees.filter(emp => emp.service_ids && emp.service_ids.includes(selectedServiceId))
                : employees;

            if (availableEmployees.length === 0) {
                select.innerHTML = '<option value="">--- Ning칰n Estilista Disponible ---</option>';
            } else {
                select.innerHTML = '<option value="" disabled selected>--- Escoge tu Estilista ---</option>';
                availableEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.docId;
                    option.textContent = emp.name;
                    select.appendChild(option);
                });
            }
        }

        // --- L칍GICA DE SERVICIOS ---

        function renderServiceList() {
            const listContainer = document.getElementById('service-list');
            listContainer.innerHTML = '';
            if (services.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 italic text-center p-4">A칰n no hay servicios. A침ade uno para empezar.</p>';
                return;
            }

            services.forEach(svc => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-xl border border-purple-100 shadow-sm flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${svc.name}</p>
                        <p class="text-xs text-gray-500">Duraci칩n: ${svc.duration_min} min | Precio: ${formatCurrency(svc.price)}</p>
                    </div>
                    <div class="space-x-2">
                        <button data-id="${svc.docId}" class="edit-service-btn text-blue-500 hover:text-blue-700"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button data-id="${svc.docId}" class="delete-service-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderServiceDropdown() {
            const select = document.getElementById('servicio');
            select.innerHTML = '';
            if (services.length === 0) {
                select.innerHTML = '<option value="">--- Ning칰n Servicio Disponible ---</option>';
            } else {
                select.innerHTML = '<option value="" disabled selected>--- Escoge tu Servicio ---</option>';
                services.forEach(svc => {
                    const option = document.createElement('option');
                    option.value = svc.docId; 
                    option.textContent = `${svc.name} (${svc.duration_min} min / ${formatCurrency(svc.price)})`;
                    select.appendChild(option);
                });
            }
        }

        function updateServiceSummary() {
            const serviceId = document.getElementById('servicio').value;
            const summaryElement = document.getElementById('service-summary');
            
            if (serviceId) {
                const service = services.find(s => s.docId === serviceId);
                if (service) {
                    summaryElement.textContent = `Servicio: ${service.name} | Duraci칩n: ${service.duration_min} minutos | Precio: ${formatCurrency(service.price)}.`;
                    summaryElement.classList.remove('hidden');
                }
            } else {
                summaryElement.classList.add('hidden');
            }
            renderEmployeeDropdown(); // Actualiza empleados seg칰n el servicio
        }


        // --- EVENT HANDLERS (ADMIN) ---

        // ADMIN LOGIN
        document.getElementById('admin-login-btn').addEventListener('click', () => {
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        });
        document.getElementById('close-admin-modal-btn').addEventListener('click', () => {
            document.getElementById('admin-modal').classList.add('hidden');
        });
        document.getElementById('login-admin-btn').addEventListener('click', () => {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('admin-modal').classList.add('hidden');
                document.getElementById('tab-admin-employees').classList.remove('hidden');
                document.getElementById('tab-admin-services').classList.remove('hidden');
                document.getElementById('admin-login-btn').textContent = 'Admin (Logueado)';
                switchTab('content-admin-employees');
                showMessage('Acceso de Administrador concedido. Los cambios se guardan en la BBDD.', 'exito');
            } else {
                showMessage('Contrase침a incorrecta. Int칠ntalo de nuevo.', 'error');
            }
        });

        // TABS
        document.getElementById('tab-agenda').addEventListener('click', () => switchTab('content-agenda'));
        document.getElementById('tab-admin-employees').addEventListener('click', () => {
            if (isAuthenticated) switchTab('content-admin-employees');
        });
        document.getElementById('tab-admin-services').addEventListener('click', () => {
            if (isAuthenticated) switchTab('content-admin-services');
        });

        // EMPLOYEE CRUD EVENTS
        document.getElementById('add-employee-btn').addEventListener('click', () => {
            document.getElementById('employee-doc-id').value = '';
            document.getElementById('employee-modal-title').textContent = 'A침adir Nuevo Estilista';
            document.getElementById('employee-form').reset();
            renderServiceCheckboxes([]); 
            document.getElementById('employee-modal').classList.remove('hidden');
        });
        document.getElementById('employee-list').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target || target.textContent.includes('Horario')) return;
            const id = target.dataset.id;
            
            if (target.classList.contains('edit-employee-btn')) {
                const emp = employees.find(e => e.docId === id);
                if (emp) {
                    document.getElementById('employee-doc-id').value = id;
                    document.getElementById('modal-employee-name').value = emp.name;
                    document.getElementById('modal-employee-schedule').value = emp.schedule || '';
                    document.getElementById('employee-modal-title').textContent = `Editar a ${emp.name}`;
                    renderServiceCheckboxes(emp.service_ids || []);
                    document.getElementById('employee-modal').classList.remove('hidden');
                }
            } else if (target.classList.contains('delete-employee-btn')) {
                if (confirm("쮼st치s seguro de eliminar a este estilista?")) {
                    deleteDoc(doc(db, EMPLOYEE_COLLECTION, id));
                    showMessage('Estilista eliminado de la BBDD.', 'exito');
                }
            }
        });
        document.getElementById('employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('employee-doc-id').value;
            const name = document.getElementById('modal-employee-name').value;
            const schedule = document.getElementById('modal-employee-schedule').value;
            const selectedServiceIds = Array.from(document.querySelectorAll('#employee-services-checkboxes input[name="employee-service"]:checked'))
                                         .map(checkbox => checkbox.value);

            const employeeData = { name, schedule, service_ids: selectedServiceIds };
            
            try {
                if (docId) {
                    await setDoc(doc(db, EMPLOYEE_COLLECTION, docId), employeeData);
                    showMessage(`Estilista ${name} actualizado en Firestore.`, 'exito');
                } else {
                    await addDoc(collection(db, EMPLOYEE_COLLECTION), employeeData);
                    showMessage(`Estilista ${name} a침adido a Firestore.`, 'exito');
                }
                document.getElementById('employee-modal').classList.add('hidden');
            } catch(e) {
                showMessage(`Error al guardar empleado: ${e.message}`, 'error');
            }
        });

        // SERVICE CRUD EVENTS
        document.getElementById('add-service-btn').addEventListener('click', () => {
            document.getElementById('service-doc-id').value = '';
            document.getElementById('service-modal-title').textContent = 'A침adir Nuevo Servicio';
            document.getElementById('service-form').reset();
            document.getElementById('service-modal').classList.remove('hidden');
        });
        document.getElementById('service-list').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            
            if (target.classList.contains('edit-service-btn')) {
                const svc = services.find(s => s.docId === id);
                if (svc) {
                    document.getElementById('service-doc-id').value = id;
                    document.getElementById('modal-service-name').value = svc.name;
                    document.getElementById('modal-service-duration').value = svc.duration_min;
                    document.getElementById('modal-service-price').value = svc.price;
                    document.getElementById('service-modal-title').textContent = `Editar Servicio: ${svc.name}`;
                    document.getElementById('service-modal').classList.remove('hidden');
                }
            } else if (target.classList.contains('delete-service-btn')) {
                if (confirm("쮼st치s seguro de eliminar este servicio?")) {
                    deleteDoc(doc(db, SERVICE_COLLECTION, id));
                    showMessage('Servicio eliminado de la BBDD.', 'exito');
                }
            }
        });
        document.getElementById('service-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('service-doc-id').value;
            const name = document.getElementById('modal-service-name').value;
            const duration_min = parseInt(document.getElementById('modal-service-duration').value);
            const price = parseFloat(document.getElementById('modal-service-price').value);

            const serviceData = { name, duration_min, price };
            
            try {
                if (docId) {
                    await setDoc(doc(db, SERVICE_COLLECTION, docId), serviceData);
                    showMessage(`Servicio ${name} actualizado en Firestore.`, 'exito');
                } else {
                    await addDoc(collection(db, SERVICE_COLLECTION), serviceData);
                    showMessage(`Servicio ${name} a침adido a Firestore.`, 'exito');
                }
                document.getElementById('service-modal').classList.add('hidden');
            } catch(e) {
                showMessage(`Error al guardar servicio: ${e.message}`, 'error');
            }
        });


        // AGENDAMIENTO Y TELEGRAM
        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-agendar');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Enviando...`;
            lucide.createIcons();
            btn.disabled = true;

            const selectedEmployee = employees.find(emp => emp.docId === document.getElementById('empleado').value);
            const selectedServiceId = document.getElementById('servicio').value;
            const selectedService = services.find(svc => svc.docId === selectedServiceId);
            
            if (!selectedService || !selectedEmployee) {
                showMessage("Error: Debes seleccionar un Servicio y un Estilista.", 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }

            // Datos enriquecidos para Telegram (como en tu views.py)
            const datos = {
                clientName: document.getElementById('nombre').value,
                clientContact: document.getElementById('contacto').value,
                serviceName: selectedService.name,
                serviceDuration: selectedService.duration_min,
                servicePrice: formatCurrency(selectedService.price),
                employeeName: selectedEmployee.name,
                employeeSchedule: selectedEmployee.schedule || 'No Definido',
                formattedTime: `${document.getElementById('fecha').value} a las ${document.getElementById('hora').value}`
            };

            try {
                const respuesta = await fetch(`${BACKEND_URL}/send-telegram`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                if (respuesta.ok) {
                    showMessage("춰Reserva exitosa! Revisa tu Telegram. 游눘", 'exito');
                    document.getElementById('form-cita').reset();
                    updateServiceSummary(); 
                } else {
                    const error = await respuesta.json();
                    throw new Error(error.message || "Error desconocido");
                }
            } catch (error) {
                console.error("Error de Agendamiento:", error);
                showMessage(`Error: Fall칩 la conexi칩n con el servidor. Verifica Render.`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });


        // --- FIREBASE LISTENERS (REAL-TIME SYNC) ---

        async function initializeAuthAndListeners() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Servicios Listener
                onSnapshot(collection(db, SERVICE_COLLECTION), (snapshot) => {
                    services = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    renderServiceDropdown();
                    renderServiceList();
                    updateServiceSummary();
                    showMessage('Datos de servicios sincronizados.', 'exito');
                }, (error) => {
                    console.error("Error al escuchar servicios:", error);
                    showMessage('Error al cargar servicios. Verifica la conexi칩n a Firestore.', 'error');
                });

                // Empleados Listener
                onSnapshot(collection(db, EMPLOYEE_COLLECTION), (snapshot) => {
                    employees = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    renderEmployeeDropdown();
                    renderEmployeeList();
                    showMessage('Datos de empleados sincronizados.', 'exito');
                }, (error) => {
                    console.error("Error al escuchar empleados:", error);
                    showMessage('Error al cargar empleados. Verifica la conexi칩n a Firestore.', 'error');
                });
                
            } catch (error) {
                console.error("Error en autenticaci칩n Firebase:", error);
                showMessage("Fallo de autenticaci칩n en Firebase. Verifica la configuraci칩n.", 'error');
            }
        }
        
        // --- ARRANQUE ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('fecha').min = new Date().toISOString().split('T')[0];
            document.getElementById('servicio').addEventListener('change', updateServiceSummary);
            initializeAuthAndListeners();
            switchTab('content-agenda'); // Mostrar la pesta침a de agenda por defecto
        });
    </script>
</body>
</html>